mads 2.1.6
Source: MIDIMate_drv.a65
     1 				    org $2000
     2
     3 				drvjtab:
     4
     5 FFFF> 2000-20EF> 4C 0C + 	jmp serial_drv.init
     6 2003 4C 14 20			jmp serial_drv.Start
     7 2006 4C 51 20			jmp serial_drv.Send
     8 2009 4C 6A 20			jmp serial_drv.Stop
     9
    10
    11 200C			    .local serial_drv
    12
    13 200C				icl './atari.inc'
Source: atari.inc
     1 = 0010			POKMSK		= $10
     2
     3 				// STATUS		= $30
     4 = 0031			CHKSUM      = $31
     5 = 003A			XMTDON		= $3A
     6 = 003B			CHKSNT		= $3B
     7
     8 = 0042			CRITIC		= $42
     9
    10 = 020C			VSEROUT		= $020C
    11
    12 = 0232			SSKCTL		= $0232
    13
    14 = D204			AUDF3		= $D204
    15 = D205			AUDC3       = $D205
    16 = D206			AUDF4		= $D206
    17 = D207			AUDC4       = $D207
    18 = D20F			SKCTL		= $D20F
    19 = D208			AUDCTL		= $D208
    20 = D20D			SEROUT		= $D20D
    21 = D20E			IRQEN		= $D20E
    22
    23 = D302			PACTL       = $d302
    14 200C				icl './fifo.inc'
Source: fifo.inc
     1 = 00FD			FIFO_HEAD   = $FD
     2 = 00FE			FIFO_TAIL   = $FE
     3 = 0600			FIFO_BUF    = $0600
    15
    16 				;--------------------------------------------------
    17 				; Initialize
    18
    19 200C			init:
    20 200C A9 D9		    lda #<DESC
    21 200E A0 20		    ldy #>DESC
    22 2010 20 BB 20		    jsr PRINT
    23
    24 2013 60				rts
    25 				;--------------------------------------------------
    26 				; Start serial port service
    27
    28 2014			Start:
    29 2014 AD 0C 02		    lda VSEROUT
    30 2017 8D D7 20		    sta OVSEROUT
    31 201A AD 0D 02		    lda VSEROUT+1
    32 201D 8D D8 20		    sta OVSEROUT+1
    33
    34 2020 A9 94			lda #<IOutMIDISer
    35 2022 8D 0C 02			sta VSEROUT
    36 2025 A9 20			lda #>IOutMIDISer
    37 2027 8D 0D 02			sta VSEROUT+1
    38
    39 				; turn on MOTOR - power up MIDIMate
    40 202A AD 02 D3			lda pactl
    41 202D 29 F7			and #$f7
    42 202F 8D 02 D3			sta pactl
    43
    44 				; set serial
    45 2032 A9 07			LDA #%00000111	; $07
    46 						; -------x - keep keyboard debounce as is
    47 						; ------x- - keep keyboard scanning as is
    48 						; -----x-- - keep fast POT scan as is
    49 						; ----0--- - clear POKEY two-tone mode
    50 						; 0------- - clear force break; serial output to zero
    51 2034 2D 32 02			AND SSKCTL
    52 2037 8D 32 02			STA SSKCTL
    53 203A 8D 0F D2			STA SKCTL
    54
    55 				; set interrupts
    56 203D A9 C7			LDA #%11000111	; $C7
    57 						; x-------  - keep Break IRQ
    58 						; -x------  - keep Other key IRQ
    59 						; -----xxx  - keep timer 1,2 & 4 IRQs
    60 203F 25 10			AND POKMSK
    61 2041 09 10			ORA #%00010000	; $10
    62 						; --0-----  - disable serial input data ready
    63 						; ---1----  - enabled serial output data ready
    64 						; ----0---  - disable serial output transmission done
    65 2043 85 10			STA POKMSK
    66 2045 8D 0E D2			STA IRQEN
    67
    68 				; checksum sent flag ($ff equals sent)
    69 2048 A9 FF			LDA #$FF
    70 204A 85 3B			STA CHKSNT
    71
    72 				; Transmission done flag - pending
    73 204C A0 01			LDY #$01
    74 204E 84 3A			STY XMTDON
    75
    76 2050 60			    RTS
    77
    78 				;--------------------------------------------------
    79 				;
    80
    81 2051			Send:
    82 				; skip if trasmission not end
    83 2051 A5 3A			LDA XMTDON
    84 2053 F0 14			BEQ exitSend
    85
    86 2055 A4 FE		    ldy fifo_tail
    87 2057 C4 FD			cpy fifo_head
    88 2059 F0 0E			beq exitSend
    89
    90 				;
    91 205B A9 01			LDA #$01
    92 					; STA STATUS
    93 205D 85 42			STA CRITIC
    94
    95 				; reset transmission done flag
    96 205F A9 00			LDA #$00
    97 2061 85 3A			STA XMTDON
    98
    99 				; start transmission by send byte to serial out
   100 2063 B9 00 06			LDA FIFO_BUF,Y
   101 2066 8D 0D D2			STA SEROUT
   102
   103 2069			exitSend:
   104 2069 60			    rts
   105
   106 				;--------------------------------------------------
   107 				; Stop serial port service
   108
   109 206A			Stop:
   110 206A AD D7 20		    lda OVSEROUT
   111 206D 0D D7 20			ora OVSEROUT
   112 2070 F0 21			beq exitUnInit
   113
   114 				; turn off MOTOR - power down MIDIMate
   115 2072 AD 02 D3			lda pactl
   116 2075 09 08			ora #$08
   117 2077 8D 02 D3			sta pactl
   118
   119 207A AD D7 20		    lda OVSEROUT
   120 207D 8D 0C 02		    sta VSEROUT
   121 2080 AD D8 20		    lda OVSEROUT+1
   122 2083 8D 0D 02		    sta VSEROUT+1
   123
   124 				; Clear interrupts
   125 				; (5) serial input data ready
   126 				; (4) serial output data required
   127 				; (3) serial out transmission finished
   128 2086 A9 C7			LDA #%11000111 ; $C7
   129 2088 25 10			AND POKMSK
   130 208A 85 10			STA POKMSK
   131 208C 8D 0E D2			STA IRQEN
   132
   133 				; clear critic NMI time
   134 208F A9 00			LDA #$00
   135 2091 85 42			STA CRITIC
   136
   137 2093			exitUnInit:
   138 2093 60				RTS
   139
   140 				;--------------------------------------------------
   141 				;Output MIDI Data by Serial Bus - Interrupt
   142
   143 2094			IOutMIDISer:
   144
   145 2094 98 48			tya:pha
   146
   147 2096 A4 FE		    ldy fifo_tail
   148 2098 C8				iny
   149 2099 C4 FD			cpy fifo_head
   150 209B D0 13			bne send_next
   151
   152 209D			dont_send_checksum:
   153 209D 84 FE		    sty fifo_tail
   154
   155 209F A5 10			lda POKMSK
   156 20A1 09 08			ora #%00001000	; $08
   157 20A3 85 10			sta POKMSK
   158 20A5 8D 0E D2			sta IRQEN
   159
   160 20A8 A9 00			LDA #$00
   161 20AA 85 42			STA CRITIC
   162
   163 20AC			serial_rti:
   164 20AC 68 A8 68			pla:tay:pla
   165 20AF 40				rti
   166
   167 20B0			send_next:
   168 20B0 84 FE		    sty fifo_tail
   169 20B2 B9 00 06			lda FIFO_BUF,y
   170 20B5 8D 0D D2			sta SEROUT
   171
   172 20B8 4C AC 20			jmp serial_rti
   173
   174 				;--------------------------------------------------
   175 				;
   176
   177 20BB				icl './print.a65'
Source: print.a65
     1 20BB			PRINT:
     2
     3 20BB			    .local
     4
     5 = 0340			ICCHID  = $0340
     6 = 0342			ICCMD   = $0342
     7 = 0344			ICBUFA  = $0344
     8 = 0348			ICBUFL  = $0348
     9 = E456			CIOV    = $E456
    10
    11 20BB A2 00		    ldx #$00
    12 20BD 9D 44 03		    sta ICBUFA,X
    13 20C0 98			    tya
    14 20C1 9D 45 03		    sta ICBUFA+1,X
    15 20C4 A9 FF		    lda #$ff
    16 20C6 9D 48 03		    sta ICBUFL,X
    17 20C9 A9 09		    lda #$09
    18 20CB 9D 42 03		    sta ICCMD,X
    19 20CE BD 40 03		    lda ICCHID,x
    20 20D1 30 03		    bmi ExitPRINT
    21 20D3 4C 56 E4		    jmp CIOV
    22 20D6			ExitPRINT:
    23 20D6 60			    rts
    24
    25 				    .endl
   178
   179 				;--------------------------------------------------
   180 				; driver variables
   181
   182 				; old serial out vector
   183 20D7 00 00		OVSEROUT    dta a(0)
   184 20D9 4D 49 44 49 4D 61 + DESC	dta c'MIDIMate Driver by GSD',$9B
   185
   186 				    .endl
   187
   188 02E2-02E3> 0C 20			ini serial_drv.init
